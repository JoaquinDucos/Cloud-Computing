<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recetas en Casa - Inicio</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #ff914d;
      --primary-dark: #ff7a26;
      --accent-color: #4cb050;
      --text-color: #333;
      --light-gray: #f5f5f5;
      --white: #ffffff;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      background-color: var(--light-gray);
      color: var(--text-color);
      line-height: 1.6;
    }

    header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      padding: 1.2rem 5%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-weight: 700;
      font-size: 1.8rem;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    nav a {
      color: white;
      text-decoration: none;
      margin-left: 25px;
      font-weight: 500;
      transition: all 0.3s ease;
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
    }

    nav a:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .contenido {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 5%;
    }

    .banner {
      background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1606787366850-de6330128bfc?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80');
      background-size: cover;
      background-position: center;
      color: white;
      text-align: center;
      padding: 4rem 2rem;
      margin-bottom: 2rem;
      border-radius: 12px;
    }

    .banner h2 {
      font-size: 2.2rem;
      margin-bottom: 1rem;
    }

    .banner p {
      font-size: 1.1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    .search-section {
      background-color: var(--white);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.08);
      margin-bottom: 2rem;
    }

    .search-title {
      margin-bottom: 1.5rem;
      position: relative;
      display: inline-block;
      padding-bottom: 8px;
    }

    .search-title::after {
      content: '';
      position: absolute;
      width: 60%;
      height: 3px;
      background-color: var(--primary-color);
      bottom: 0;
      left: 0;
    }

    .search-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
    }

    .search-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    .search-type {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }

    .search-type label {
      margin-right: 15px;
      display: flex;
      align-items: center;
      cursor: pointer;
      margin-bottom: 5px;
    }

    .search-type input {
      margin-right: 5px;
    }

    .btn-search {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
      align-self: flex-end;
    }

    .btn-search:hover {
      background-color: var(--primary-dark);
    }

    .btn-add {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      transition: background-color 0.3s;
      margin-bottom: 1.5rem;
    }

    .btn-add i {
      margin-right: 8px;
    }

    .btn-add:hover {
      background-color: #429644;
    }

    .destacadas {
      margin-top: 2rem;
    }

    .destacadas h2 {
      margin-bottom: 1.5rem;
      position: relative;
      display: inline-block;
      padding-bottom: 8px;
    }

    .destacadas h2::after {
      content: '';
      position: absolute;
      width: 60%;
      height: 3px;
      background-color: var(--primary-color);
      bottom: 0;
      left: 0;
    }

    .recetas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 25px;
    }

    .receta {
      background-color: var(--white);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 15px rgba(0,0,0,0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .receta:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.12);
    }

    .receta-img {
      height: 180px;
      background-size: cover;
      background-position: center;
    }

    .pizza { background-image: url('https://images.unsplash.com/photo-1513104890138-7c749659a591?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'); }
    .galletas { background-image: url('https://images.unsplash.com/photo-1558961363-fa8fdf82db35?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'); }
    .quinoa { background-image: url('https://images.unsplash.com/photo-1512621776951-a57141f2eefd?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'); }

    .receta-info {
      padding: 1.5rem;
    }

    .receta h3 {
      margin-bottom: 10px;
      color: var(--primary-dark);
    }

    .receta p {
      color: #666;
      margin-bottom: 15px;
    }

    .receta-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .tiempo {
      font-size: 0.9rem;
      color: #777;
    }

    .btn {
      background-color: var(--accent-color);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .btn:hover {
      background-color: #429644;
    }

    /* Modal para agregar receta */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: var(--white);
      margin: 5% auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: black;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-group input, 
    .form-group textarea, 
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      font-family: 'Poppins', 'Segoe UI', sans-serif;
    }

    .form-group textarea {
      min-height: 150px;
      resize: vertical;
    }

    .ingredient-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .ingredient-row input {
      flex: 1;
    }

    .ingredient-row button {
      color: white;
      border: none;
      border-radius: 5px;
      width: 32px;
      height: 32px;
      cursor: pointer;
    }

    .remove-ingredient {
      background-color: #e74c3c;
    }

    .add-search-ingredient {
      background-color: var(--accent-color);
    }

    .add-ingredient {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .submit-recipe {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
    }

    .search-results {
      margin-top: 2rem;
      display: none;
    }

    /* Estilos para las etiquetas de ingredientes */
    .search-ingredients-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 15px;
    }

    .ingredient-tag {
      background-color: var(--primary-color);
      color: white;
      padding: 6px 12px;
      border-radius: 50px;
      display: inline-flex;
      align-items: center;
      font-size: 0.9rem;
    }

    .remove-tag {
      margin-left: 8px;
      background: none;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.2rem;
    }

    footer {
      background-color: #333;
      color: white;
      text-align: center;
      padding: 2rem;
      margin-top: 3rem;
    }

    @media (max-width: 768px) {
      .recetas-grid {
        grid-template-columns: 1fr;
      }
      
      .header-container {
        flex-direction: column;
        gap: 1rem;
      }
      
      .user-info {
        order: -1;
      }
      
      nav {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }
      
      nav a {
        margin: 0;
      }
    }

    /* Loading spinner */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .user-menu.active .dropdown {
      display: block;
    }

    .loading-message {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .loading-message p {
      font-size: 1.1rem;
    }

    #no-recipes-message {
      background-color: var(--white);
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin: 1rem 0;
    }

    #no-recipes-message h3 {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
    <p>Verificando autenticaci√≥n...</p>
  </div>

  <header>
    <div class="header-container">
      <h1>Recetas en Casa</h1>
      <div class="user-info">
        <div id="user-avatar" class="user-avatar"></div>
        <span id="user-name">Usuario</span>
      </div>
      <nav>
        <a href="#" onclick="showMyRecipes()">Mis Recetas</a>
        <a href="#" onclick="showFavorites()">Favoritos</a>
        <button class="logout-btn" onclick="logout()">Salir</button>
      </nav>
    </div>
  </header>

  <div class="contenido">
    <div class="banner">
      <h2>Descubre el chef que llevas dentro</h2>
      <p>Explora cientos de recetas caseras f√°ciles de preparar y comparte tus creaciones con la comunidad</p>
    </div>

    <!-- Secci√≥n de b√∫squeda -->
    <div class="search-section">
      <h2 class="search-title">Buscar Recetas</h2>
      <div class="search-container">
        <div class="search-box">
          <div class="search-type">
            <label>
              <input type="radio" name="search-type" value="nombre" checked> Buscar por nombre
            </label>
            <label>
              <input type="radio" name="search-type" value="categoria"> Buscar por categor√≠a
            </label>
            <label>
              <input type="radio" name="search-type" value="ingredientes"> Buscar por ingredientes
            </label>
          </div>
          
          <!-- Campo para b√∫squeda por nombre -->
          <div id="search-nombre-container">
            <input type="text" id="search-input" class="search-input" placeholder="Escribe el nombre de la receta...">
          </div>
          
          <!-- Campo para b√∫squeda por categor√≠a (inicialmente oculto) -->
          <div id="search-categoria-container" style="display: none; margin-top: 10px;">
            <select id="categoria-select" class="search-input">
              <option value="">Selecciona una categor√≠a</option>
              <option value="desayuno">Desayuno</option>
              <option value="almuerzo">Almuerzo</option>
              <option value="cena">Cena</option>
              <option value="postre">Postre</option>
              <option value="saludable">Saludable</option>
              <option value="vegetariano">Vegetariano</option>
            </select>
          </div>
          
          <!-- Campo para b√∫squeda por ingredientes (inicialmente oculto) -->
          <div id="search-ingredientes-container" style="display: none; margin-top: 10px;">
            <div class="search-ingredients-list" id="search-ingredients-tags"></div>
            <div class="ingredient-row">
              <input type="text" id="ingrediente-input" class="search-input" placeholder="A√±ade un ingrediente...">
              <button type="button" id="add-search-ingredient" class="add-search-ingredient">+</button>
            </div>
          </div>
        </div>
        <button class="btn-search" id="btn-search">Buscar</button>
      </div>
    </div>

    <!-- Bot√≥n para agregar receta -->
    <button class="btn-add" id="btn-add-recipe">
      <i class="fas fa-plus"></i> Agregar nueva receta
    </button>

    <!-- Resultados de b√∫squeda -->
    <div class="search-results" id="search-results">
      <h2>Resultados de b√∫squeda</h2>
      <div class="recetas-grid" id="search-results-grid">
        <!-- Los resultados se cargar√°n aqu√≠ din√°micamente -->
      </div>
    </div>

    <div class="destacadas">
      <h2>Mis Recetas</h2>
      <div id="my-recipes-container" style="display: none;">
        <div class="recetas-grid" id="my-recipes-grid">
          <!-- Las recetas del usuario se cargar√°n aqu√≠ din√°micamente -->
        </div>
      </div>
      
      <!-- Mensaje cuando no hay recetas -->
      <div id="no-recipes-message" style="display: none; text-align: center; padding: 2rem;">
        <h3>¬°A√∫n no tienes recetas!</h3>
        <p>¬øPor qu√© no empiezas creando tu primera receta?</p>
        <button onclick="document.getElementById('add-recipe-modal').style.display='block'" class="btn" style="margin-top: 1rem;">
          <i class="fas fa-plus"></i> Crear mi primera receta
        </button>
      </div>
      
      <!-- Mensaje de carga -->
      <div id="recipes-loading" class="loading-message">
        <p>Cargando tus recetas...</p>
      </div>
    </div>
  </div>

  <!-- Modal para agregar receta -->
  <div id="add-recipe-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Agregar Nueva Receta</h2>
      <form id="add-recipe-form">
        <div class="form-group">
          <label for="recipe-name">Nombre de la receta</label>
          <input type="text" id="recipe-name" name="nombre" required>
        </div>
        
        <div class="form-group">
          <label for="recipe-time">Tiempo de preparaci√≥n (minutos)</label>
          <input type="number" id="recipe-time" name="tiempo" min="1" required>
        </div>
        
        <div class="form-group">
          <label for="recipe-category">Categor√≠a</label>
          <select id="recipe-category" name="categoria" required>
            <option value="">Selecciona una categor√≠a</option>
            <option value="desayuno">Desayuno</option>
            <option value="almuerzo">Almuerzo</option>
            <option value="cena">Cena</option>
            <option value="postre">Postre</option>
            <option value="saludable">Saludable</option>
            <option value="vegetariano">Vegetariano</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Ingredientes</label>
          <div id="ingredients-container">
            <div class="ingredient-row">
              <input type="text" name="ingredientes[]" placeholder="Ingrediente" required>
              <button type="button" class="remove-ingredient">-</button>
            </div>
          </div>
          <button type="button" class="add-ingredient" id="add-ingredient-btn">+ Agregar otro ingrediente</button>
        </div>
        
        <div class="form-group">
          <label for="recipe-instructions">Instrucciones de preparaci√≥n</label>
          <textarea id="recipe-instructions" name="instrucciones" required></textarea>
        </div>
        
        <button type="submit" class="submit-recipe">Guardar Receta</button>
      </form>
    </div>
  </div>

  <footer>
    <p>¬© 2025 Recetas en Casa - Todos los derechos reservados</p>
  </footer>

  <!-- Configuration Script -->
  <script src="config.js"></script>
  
  <!-- Cognito Auth Script -->
  <script src="auth.js"></script>

  <script>
    // API Gateway URL from global configuration
    const api_gateway_url = window.APP_CONFIG.API_GATEWAY_URL;
    
    // Global variables
    let searchIngredients = [];
    let currentUser = null;

    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', async function() {
      // Wait for auth to be ready
      if (!auth) {
        await new Promise(resolve => {
          document.addEventListener('authReady', resolve, { once: true });
        });
      }
      
      try {
        const isAuthenticated = await auth.initialize();
        
        if (!isAuthenticated) {
          // User not authenticated, redirect to login
          window.location.href = 'index.html';
          return;
        }

        // User is authenticated, get user info and setup page
        currentUser = auth.getUser();
        setupUserInterface();
        hideLoadingOverlay();
        
      } catch (error) {
        console.error('Authentication error:', error);
        window.location.href = 'index.html';
      }
    });

    function setupUserInterface() {
      // Display user information
      const userAvatar = document.getElementById('user-avatar');
      const userName = document.getElementById('user-name');
      
      if (currentUser) {
        // Extract first letter of name or email for avatar
        const name = currentUser.name || currentUser.email || 'Usuario';
        const firstLetter = name.charAt(0).toUpperCase();
        
        userAvatar.textContent = firstLetter;
        userName.textContent = name.split('@')[0]; // Remove domain from email if present
      }
      
      // Load user's recipes automatically when page loads
      loadMyRecipesOnHome();
    }

    function hideLoadingOverlay() {
      const overlay = document.getElementById('loading-overlay');
      overlay.style.display = 'none';
    }

    function logout() {
      if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
        auth.logout();
      }
    }

    // Load user's recipes and display them in the main section
    async function loadMyRecipesOnHome() {
      const loadingElement = document.getElementById('recipes-loading');
      const containerElement = document.getElementById('my-recipes-container');
      const noRecipesElement = document.getElementById('no-recipes-message');
      
      try {
        loadingElement.style.display = 'block';
        containerElement.style.display = 'none';
        noRecipesElement.style.display = 'none';
        
        const response = await auth.makeAuthenticatedRequest(`${api_gateway_url}/recipes`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const responseData = await response.json();
        
        // Handle both direct array and wrapped object formats
        let recipes;
        if (Array.isArray(responseData)) {
          recipes = responseData;
        } else if (responseData && Array.isArray(responseData.recipes)) {
          recipes = responseData.recipes;
        } else {
          console.error('Unexpected response format:', responseData);
          recipes = [];
        }
        
        loadingElement.style.display = 'none';
        
        if (recipes.length === 0) {
          noRecipesElement.style.display = 'block';
        } else {
          displayRecipesInHome(recipes);
          containerElement.style.display = 'block';
        }
        
      } catch (error) {
        console.error('Error loading recipes:', error);
        loadingElement.style.display = 'none';
        noRecipesElement.style.display = 'block';
      }
    }
    
    // Display recipes in the main home grid
    function displayRecipesInHome(recipes) {
      const grid = document.getElementById('my-recipes-grid');
      grid.innerHTML = '';
      
      recipes.forEach(recipe => {
        const recipeCard = document.createElement('div');
        recipeCard.className = 'receta';
        
        // Generate image class based on category
        const categoryImageMap = {
          'desayuno': 'desayuno',
          'almuerzo': 'almuerzo', 
          'cena': 'cena',
          'postre': 'postre',
          'saludable': 'saludable',
          'vegetariano': 'vegetariano'
        };
        
        const imageClass = categoryImageMap[recipe.category?.toLowerCase()] || 'default';
        
        // Truncate instructions for preview
        const instructions = recipe.instructions || 'Sin instrucciones disponibles';
        const shortInstructions = Array.isArray(instructions) 
          ? instructions[0]?.substring(0, 100) + '...'
          : instructions.substring(0, 100) + '...';
        
        recipeCard.innerHTML = `
          <div class="receta-img ${imageClass}"></div>
          <div class="receta-info">
            <h3>${recipe.title || 'Sin t√≠tulo'}</h3>
            <p><strong>Categor√≠a:</strong> ${recipe.category || 'Sin categor√≠a'}</p>
            <p>${shortInstructions}</p>
            <div class="receta-footer">
              <span class="tiempo">‚è±Ô∏è ${recipe.time || 0} minutos</span>
              <a href="receta.html?id=${recipe.id}" class="btn">Ver receta</a>
            </div>
          </div>
        `;
        
        grid.appendChild(recipeCard);
      });
    }

    // Mostrar mis recetas (funci√≥n para el bot√≥n del header)
    async function showMyRecipes() {
      if (!auth.isAuthenticated) {
        alert('Debes iniciar sesi√≥n para ver tus recetas.');
        return;
      }
      
      // Scroll to the main recipes section
      const recipesSection = document.querySelector('.destacadas');
      if (recipesSection) {
        recipesSection.scrollIntoView({ behavior: 'smooth' });
      }
      
      // If there are no recipes shown yet, reload them
      const container = document.getElementById('my-recipes-container');
      if (container.style.display === 'none') {
        await loadMyRecipesOnHome();
      }
    }

    function showFavorites() {
      alert('Funcionalidad en desarrollo: Favoritos');
    }

    // Configuraci√≥n de tipos de b√∫squeda
    const searchTypeRadios = document.querySelectorAll('input[name="search-type"]');
    const searchNombreContainer = document.getElementById('search-nombre-container');
    const searchCategoriaContainer = document.getElementById('search-categoria-container');
    const searchIngredientesContainer = document.getElementById('search-ingredientes-container');
    
    // Cambiar tipo de b√∫squeda
    searchTypeRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        // Ocultar todos los contenedores de b√∫squeda
        searchNombreContainer.style.display = 'none';
        searchCategoriaContainer.style.display = 'none';
        searchIngredientesContainer.style.display = 'none';
        
        // Mostrar el contenedor correspondiente al tipo seleccionado
        if (this.value === 'nombre') {
          searchNombreContainer.style.display = 'block';
        } else if (this.value === 'categoria') {
          searchCategoriaContainer.style.display = 'block';
        } else if (this.value === 'ingredientes') {
          searchIngredientesContainer.style.display = 'block';
        }
      });
    });
    
    // Gesti√≥n de ingredientes para b√∫squeda
    const addSearchIngredientBtn = document.getElementById('add-search-ingredient');
    const ingredienteInput = document.getElementById('ingrediente-input');
    const searchIngredientsTagsContainer = document.getElementById('search-ingredients-tags');
    
    // Funci√≥n para agregar un ingrediente a la b√∫squeda
    function addSearchIngredient() {
      const ingrediente = ingredienteInput.value.trim();
      if (ingrediente && !searchIngredients.includes(ingrediente)) {
        searchIngredients.push(ingrediente);
        renderSearchIngredientTags();
        ingredienteInput.value = '';
        ingredienteInput.focus();
      }
    }
    
    // Agregar ingrediente al hacer clic en el bot√≥n +
    addSearchIngredientBtn.addEventListener('click', addSearchIngredient);
    
    // Agregar ingrediente al presionar Enter
    ingredienteInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addSearchIngredient();
      }
    });
    
    // Renderizar etiquetas de ingredientes
    function renderSearchIngredientTags() {
      searchIngredientsTagsContainer.innerHTML = '';
      
      searchIngredients.forEach((ingrediente, index) => {
        const tag = document.createElement('div');
        tag.className = 'ingredient-tag';
        tag.innerHTML = `
          ${ingrediente}
          <button type="button" class="remove-tag" data-index="${index}">√ó</button>
        `;
        searchIngredientsTagsContainer.appendChild(tag);
      });
      
      // Agregar listeners a los botones de eliminar
      document.querySelectorAll('.remove-tag').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          searchIngredients.splice(index, 1);
          renderSearchIngredientTags();
        });
      });
    }

    // Modal para agregar receta
    const modal = document.getElementById('add-recipe-modal');
    const btnAddRecipe = document.getElementById('btn-add-recipe');
    const closeBtn = document.getElementsByClassName('close')[0];

    btnAddRecipe.onclick = function() {
      modal.style.display = 'block';
    }

    closeBtn.onclick = function() {
      modal.style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // Agregar y eliminar ingredientes en el formulario de receta
    const addIngredientBtn = document.getElementById('add-ingredient-btn');
    const ingredientsContainer = document.getElementById('ingredients-container');

    addIngredientBtn.addEventListener('click', function() {
      const ingredientRow = document.createElement('div');
      ingredientRow.className = 'ingredient-row';
      ingredientRow.innerHTML = `
        <input type="text" name="ingredientes[]" placeholder="Ingrediente" required>
        <button type="button" class="remove-ingredient">-</button>
      `;
      ingredientsContainer.appendChild(ingredientRow);
      
      // Agregar evento al bot√≥n de eliminar
      const removeBtn = ingredientRow.querySelector('.remove-ingredient');
      removeBtn.addEventListener('click', function() {
        ingredientsContainer.removeChild(ingredientRow);
      });
    });

    // Agregar listener a botones de eliminar existentes
    document.addEventListener('click', function(e) {
      if (e.target && e.target.className === 'remove-ingredient') {
        const row = e.target.parentNode;
        ingredientsContainer.removeChild(row);
      }
    });

    // Enviar formulario de receta
    document.getElementById('add-recipe-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!auth.isAuthenticated) {
        alert('Debes estar autenticado para crear una receta');
        return;
      }
      
      // Obtener todos los ingredientes
      const ingredientInputs = document.querySelectorAll('input[name="ingredientes[]"]');
      const ingredientes = Array.from(ingredientInputs).map(input => input.value);
      
      const recetaData = {
        title: document.getElementById('recipe-name').value,
        time: parseInt(document.getElementById('recipe-time').value),
        category: document.getElementById('recipe-category').value,
        description: '',
        ingredients: ingredientes,
        instructions: document.getElementById('recipe-instructions').value.split('\n').filter(line => line.trim() !== ''),
        imageUrl: null
      };
      
      try {
        console.log('Sending recipe data:', recetaData);
        
        const response = await auth.makeAuthenticatedRequest(`${api_gateway_url}/recipes`, {
          method: 'POST',
          body: JSON.stringify(recetaData)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Response data:', result);
        
        alert('¬°Receta guardada correctamente!');
        modal.style.display = 'none';
        document.getElementById('add-recipe-form').reset();
        location.reload();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar la receta. Por favor, intenta nuevamente.');
      }
    });

    // B√∫squeda de recetas
    document.getElementById('btn-search').addEventListener('click', async function() {
      if (!auth.isAuthenticated) {
        alert('Debes estar autenticado para buscar recetas');
        return;
      }

      const searchType = document.querySelector('input[name="search-type"]:checked').value;
      let searchParams = '';
      
      if (searchType === 'nombre') {
        const searchInput = document.getElementById('search-input').value.trim();
        if (!searchInput) {
          alert('Por favor, ingresa un t√©rmino de b√∫squeda');
          return;
        }
        searchParams = `title=${encodeURIComponent(searchInput)}`;
      } 
      else if (searchType === 'categoria') {
        const categoria = document.getElementById('categoria-select').value;
        if (!categoria) {
          alert('Por favor, selecciona una categor√≠a');
          return;
        }
        searchParams = `category=${encodeURIComponent(categoria)}`;
      }
      else if (searchType === 'ingredientes') {
        if (searchIngredients.length === 0) {
          alert('Por favor, agrega al menos un ingrediente');
          return;
        }
        searchParams = `ingredients=${encodeURIComponent(searchIngredients.join(','))}`;
      }
      
      try {
        let url = `${api_gateway_url}/recipes/search?${searchParams}`;
        console.log('Search URL:', url);
        
        const response = await auth.makeAuthenticatedRequest(url);
        console.log('Search response status:', response.status);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          console.error('Search failed:', errorData);
          throw new Error(`HTTP ${response.status}: ${errorData.error || 'Search failed'}`);
        }
        
        const recetas = await response.json();
        console.log('Search results:', recetas);
        
        displaySearchResults(recetas);
      } catch (error) {
        console.error('Error en la b√∫squeda:', error);
        alert(`Error al buscar recetas: ${error.message}`);
      }
    });

    // Mostrar resultados de b√∫squeda
    function displaySearchResults(recetas) {
      const resultsContainer = document.getElementById('search-results');
      const resultsGrid = document.getElementById('search-results-grid');
      
      // Limpiar resultados anteriores
      resultsGrid.innerHTML = '';
      
      // Verificar si recetas es un array
      if (!Array.isArray(recetas)) {
        console.error('Expected array but got:', recetas);
        resultsGrid.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #e74c3c;">
            <h3>‚ö†Ô∏è Error al cargar resultados</h3>
            <p>El servidor devolvi√≥ datos inesperados. Por favor, intenta de nuevo.</p>
          </div>
        `;
        resultsContainer.style.display = 'block';
        return;
      }
      
      if (recetas.length === 0) {
        resultsGrid.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #666;">
            <h3>üîç No se encontraron recetas</h3>
            <p>No se encontraron recetas que coincidan con tu b√∫squeda.</p>
          </div>
        `;
        resultsContainer.style.display = 'block';
        return;
      }
      
      // Crear tarjetas para cada receta encontrada
      recetas.forEach(receta => {
        const recetaCard = document.createElement('div');
        recetaCard.className = 'receta';
        
        // Usamos una imagen gen√©rica de comida
        const imgClass = ['pizza', 'galletas', 'quinoa'][Math.floor(Math.random() * 3)];
        
        // Limitamos la longitud del texto de instrucciones para mostrar
        const instruccionesCortas = Array.isArray(receta.instructions) 
          ? receta.instructions.join(' ').substring(0, 100) + '...'
          : (receta.instructions || 'No hay instrucciones disponibles.').substring(0, 100) + '...';
        
        recetaCard.innerHTML = `
          <div class="receta-img ${imgClass}"></div>
          <div class="receta-info">
            <h3>${receta.title}</h3>
            <p><strong>Categor√≠a:</strong> ${receta.category || 'N/A'}</p>
            <p>${instruccionesCortas}</p>
            <div class="receta-footer">
              <span class="tiempo">‚è±Ô∏è ${receta.time} minutos</span>
              <a href="receta.html?id=${receta.id}" class="btn">Ver receta</a>
            </div>
          </div>
        `;
        
        resultsGrid.appendChild(recetaCard);
      });
      
      resultsContainer.style.display = 'block';
      
      // Scroll to results
      resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
  </script>

</body>
</html>